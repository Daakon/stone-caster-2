{
  "module_id": "agency_presence_guardrails",
  "version": "1.1.0",
  "notes": "Merged: preserves all original runtime systems and adds approved WC55 updates (safe-location suggestion, generic proactivity with stall detection, relationship/alert surfacing, numbered-when-story choice rules, mechanics default visibility).",
  "$schema": "rpg/agency.presence-and-guardrails.schema.json",
  "speaker_rules": {
    "player_is_you_only": true,
    "name_lock": true
  },
  "turn_sequencer": {
    "fifo": true,
    "max_parallel_intents": 1
  },
  "ambient_scheduler": {
    "npc_to_npc_max_per_turn": 1,
    "cooldown_turns": 1
  },
  "safety_overrides": {
    "children_in_party_blocks_offense": true,
    "severe_wounded_blocks_offense": true,
    "recent_alarm_raises_stealth_dc": true
  },
  "consent": {
    "pc_proposes_npc_approves": true
  },
  "first_meet_policy": {
    "observable_traits_only": true
  },
  "policy": {
    "player_speaker_guard": true,
    "actions_player_only": true,
    "pause_on_out_of_character": true,
    "name_lock_enabled": true,
    "turn_sequencer": {
      "enabled": true,
      "fifo": true,
      "max_parallel_intents": 1
    },
    "ooc_detection": {
      "enabled": true,
      "patterns": ["OOC", "(meta)", "[out of character]"]
    }
  },
  "presence": {
    "states": ["present", "offscreen-task", "resting", "absent", "dead"],
    "on_scene_start_reestablish": true,
    "on_change_emit_clause": true,
    "rehydrate_on_load": true
  },
  "agency_loop": {
    "allow_ambient_extra_beat": {
      "enabled": true,
      "eligible_phases": [
        "scene_preamble",
        "scene_body",
        "post_outcome_reflection"
      ],
      "ineligible_phases": ["outcome_render", "choice_menu_render"],
      "notes": "Ambient beats are preserved but never injected during outcome/choice rendering."
    },
    "idleness_detector": {
      "name": "scene_quiet_and_two_idle",
      "ignore_when_render_lock": true,
      "min_quiet_ms": 120,
      "min_idle_entities": 2
    }
  },
  "aps_weights": {
    "role_stakes_max": 3,
    "proximity_max": 2,
    "bond_pull_max": 2,
    "agenda_urgency_max": 3,
    "trigger_flags_max": 4,
    "cooldown_max": 3
  },
  "partners": {
    "adjacency": "near",
    "auto_assist_per_scene": 1,
    "failsafe_interpose": {
      "enabled": true,
      "trigger": {
        "player_hearts_lte": 2,
        "death_risk_crit_imminent": true
      }
    }
  },
  "triggers": {
    "threat_spike": {
      "aps_bonus": 2
    },
    "moral_pin": {
      "aps_bonus": 2
    },
    "puzzle_lock": {
      "aps_bonus": 1
    },
    "injury_fear": {
      "aps_bonus": 2
    },
    "time_advance": {
      "aps_bonus": 1
    },
    "social_cue": {
      "aps_bonus": 1
    }
  },
  "agendas": {
    "fields": [
      "agenda",
      "stance",
      "cooldown_speak",
      "last_action_turn",
      "last_action_tags",
      "partner_of",
      "guard_targets",
      "interjection_bias",
      "loyalty_magnitude"
    ],
    "defaults": {
      "cooldown_speak": 0,
      "interjection_bias": 1,
      "stance": "wary",
      "loyalty_magnitude": "glimmer"
    }
  },
  "render_guards": {
    "phase_windows": {
      "outcome_render": {
        "locks": ["no_ambient", "no_inserts"]
      },
      "choice_menu_render": {
        "locks": ["no_ambient", "no_inserts"]
      }
    },
    "strict_phase_boundaries": true,
    "merge_strategy": "buffered_commit"
  },
  "channels": {
    "npc_social": {
      "enabled": true,
      "eligible_phases": ["scene_body", "post_outcome_reflection"],
      "ineligible_phases": ["outcome_render", "choice_menu_render"],
      "max_per_scene": 1
    }
  },
  "beat_scheduler": {
    "default_channel": "ambient",
    "npc_weight_formula": "let base=1.0; let detail=0.5 + 0.5*(npc.computed.narrative_detail_score ?? 0); let mult=(npc.state=='promoted'?1.5:(npc.state=='inactive'?0:1)); return base*detail*mult;",
    "eligible_phases": [
      "scene_preamble",
      "scene_body",
      "post_outcome_reflection"
    ],
    "ineligible_phases": ["outcome_render", "choice_menu_render"],
    "defer_if_locked": true,
    "defer_to_phase": "post_outcome_reflection",
    "max_deferrals": 1,
    "npc_npc_weight_formula": "let w = (npcA.computed.narrative_detail_score + npcB.computed.narrative_detail_score)/2; let bias = relationship_bias(npcA, npcB); return (0.5 + 0.5*w) * (1 + bias);"
  },
  "logging": {
    "phase_trace": {
      "enabled": true,
      "include": ["active_phase", "locks", "scheduled_beats", "deferred_beats"],
      "redact_story_text": true
    }
  },
  "role_cues": {
    "healer": [
      "warn_bleed_poison",
      "stabilize_failsafe",
      "urge_rest_low_hearts"
    ],
    "guardian": ["body_block", "call_lines_of_fire", "urge_fallback"],
    "scout": ["point_tracks", "lines_of_sight", "ambush_geometry"],
    "face": ["deescalate", "status_translate", "catch_lie"],
    "trickster": ["distraction", "trap_check", "disarm"],
    "mage": ["mark_wards", "counter_ritual", "magical_caution"],
    "shifter_bonded": ["mirror_threat_posture", "scent_cue", "pack_positioning"]
  },
  "runtime_signals": {
    "suppress_choice_tags_when_unsafe": {
      "conditions_any": [
        "children_rescued:true AND safe_zone_reached:false",
        "party_wounded_severe:true"
      ],
      "suppress": ["raid", "assault", "strike_next_outpost"],
      "inject": [
        {
          "tag": "escort",
          "label": "Escort the children and wounded to safety first."
        },
        {
          "tag": "conceal",
          "label": "Conceal tracks and set simple wards before moving."
        }
      ]
    }
  },
  "save_prompting": {
    "enabled": true,
    "offer_every_n_turns": 6,
    "offer_on_day_complete": true,
    "choice_label": "ðŸ’¾ Save progress",
    "after_save_choices": [
      {
        "tag": "continue",
        "label": "Continue from here"
      },
      {
        "tag": "stop",
        "label": "Stop for now"
      }
    ],
    "export_modes": ["compact", "verbose", "raw_json"]
  },
  "save_load": {
    "persist_fields": [
      "presence",
      "agenda",
      "stance",
      "cooldown_speak",
      "last_action_turn",
      "last_action_tags",
      "partner_of",
      "guard_targets",
      "interjection_bias",
      "loyalty_magnitude"
    ]
  },
  "settings": {
    "stall_exchanges_threshold": 3,
    "proactivity_cooldown_turns": 2,
    "max_proactivity_beats_per_scene": 2,
    "max_npc_interjections_per_turn": 2,
    "min_player_choices_when_story": 1,
    "max_player_choices_when_story": 5
  },
  "interjection_rules": {
    "per_turn_limit": 2,
    "length_hint": "short",
    "who_may_interject": "relevant_present_npcs_only",
    "avoid_duplicates_in_row": true
  },
  "progress_tracking": {
    "exchanges_without_progress_counter": true,
    "what_counts_as_progress": [
      "objective_tag_advanced",
      "quest_flag_changed",
      "scene_goal_resolved",
      "location_transition_committed",
      "relationship_delta_applied"
    ]
  },
  "npc_advice_policy": {
    "enabled": true,
    "require_fit": true,
    "fit_rule": "npc.skills.tiers[required_skill] >= min_tier OR npc.traits includes 'reckless'",
    "on_mismatch": "discourage_or_offer_alt",
    "alt_generator": "replace 'sneak' with 'distract' if social>=2; replace 'lockpick' with 'search for key' if lore>=2"
  },
  "npc_proactivity": {
    "enabled": true,
    "trigger_when": "exchanges_without_progress >= settings.stall_exchanges_threshold",
    "cooldown_turns": 2,
    "max_per_scene": 2,
    "behaviors": ["suggest_option", "offer_assist", "seek_resource"],
    "selection_policy": {
      "order": [
        "by_scene_relevance",
        "by_availability",
        "by_player_relationship_desc",
        "tiebreak_random"
      ],
      "exclude_if": [
        "npc_is_hostile_now",
        "npc_is_busy_offscreen",
        "npc_recently_pushed_within_cooldown"
      ]
    },
    "behavior_templates": {
      "suggest_option": "{npc_name}: â€˜{brief_suggestion}â€™",
      "offer_assist": "{npc_name}: â€˜Let me {assist_action} while you {player_focus}.â€™",
      "seek_resource": "{npc_name}: â€˜We need {resource}. Iâ€™ll check {nearby_source}.â€™"
    }
  },
  "npc_location_suggestion": {
    "enabled": true,
    "triggers_any": [
      "party_needs_shelter",
      "wounded_in_party",
      "after_heavy_combat",
      "threat_level_high",
      "nightfall_imminent"
    ],
    "selector": "npc.familiar_locations.filter(l => l.tags?.includes('safe_haven')).sortBy('proximity')",
    "preference_rules": [
      "prefer_tier_0_if_available",
      "prefer_known_over_unknown",
      "avoid_repeating_same_location_twice_in_a_row"
    ],
    "utterance_template": "{npc_name}: â€˜The {location_name} should be quiet enough. We can breathe there.â€™"
  },
  "intimacy": {
    "npc_approval_required": true,
    "beat_gating_enabled": true,
    "explicitness_cap_enabled": false,
    "proximity_fade_rule_enabled": false,
    "sensory_language_budget": null,
    "metaphors": {
      "enabled": true,
      "budget": {
        "per_beat": 1,
        "per_compound_beat": 2
      },
      "render_style": "inline"
    },
    "npc_compound_beats": {
      "enabled": true,
      "max_actions_per_compound": 3
    },
    "detail_budget": {
      "per_beat": 3,
      "per_compound_beat": 6
    }
  },
  "npc_consent_policy": {
    "description": "PC proposes; NPC approves before reaction.",
    "enforced": true,
    "on_denial": "offer_alternatives"
  },
  "relationships": {
    "keys": ["trust", "warmth", "respect", "romance", "desire", "awe"],
    "desire_keys": [
      "romance",
      "desire",
      "ambition",
      "fear",
      "curiosity",
      "loyalty",
      "acceptance"
    ],
    "defaults": {
      "trust": 0,
      "warmth": 0,
      "respect": 0,
      "romance": 0,
      "desire": 0,
      "awe": 0
    },
    "decay_per_day": {
      "trust": 0,
      "warmth": 0,
      "respect": 0,
      "romance": -0.05,
      "desire": -0.05,
      "awe": -0.02
    },
    "clamp_range": [-3, 3],
    "ui": {
      "glyphs": {
        "trust": "shield_check",
        "warmth": "hand_heart",
        "respect": "medal",
        "romance": "heart_full",
        "desire": "flame_small",
        "awe": "sparkles"
      },
      "desire_subglyphs": {
        "romance": "heart_outline",
        "desire": "flame_outline",
        "ambition": "flag",
        "fear": "alert",
        "curiosity": "compass",
        "loyalty": "link",
        "acceptance": "leaf"
      }
    },
    "migration": {
      "map_old_keys": {
        "energy": "desire"
      },
      "fill_missing_with": 0
    }
  },
  "relationship_and_alert": {
    "reaction_tiers": {
      "crit_success": {
        "alert_delta": -1,
        "relationship_hint": "+small_if_applicable"
      },
      "success": {
        "alert_delta": 0
      },
      "partial": {
        "alert_delta": 1,
        "cost_hint": "time_or_resource"
      },
      "fail": {
        "alert_delta": 1
      },
      "crit_fail": {
        "alert_delta": 2
      }
    },
    "surface_changes_when_show_mechanics": true
  },
  "choice_rules": {
    "numbered_when_story": true,
    "min": 1,
    "max": 5
  },
  "failsafes": {
    "do_not_push_if": [
      "player_is_in_character_creation",
      "player_is_answering_meta_question",
      "combat_round_in_progress",
      "cutscene_flag_active"
    ],
    "de_duplication": {
      "suppress_identical_suggestions_within_scene": true,
      "cooldown_turns_per_suggestion": 3
    }
  }
}
